# Use an Ubuntu base image
Bootstrap: docker
From: ubuntu:latest

%environment
    export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/ImageSmith
    export PYTHONNOUSERSITE="true"
    export PIP_BREAK_SYSTEM_PACKAGES=1


%post
    # Update and install required packages
    apt-get update && apt-get install -y --no-install-recommends \
        bash \
        build-essential \
        golang \
        git \
        linux-headers-generic \
        libseccomp-dev \
        squashfs-tools \
        curl \
        libopenblas-dev \
        gfortran \
        python3 \
        python3-pip \
        python3-dev \
        python3-setuptools \
        python3-wheel \
        libxml2-dev \
        libcurl4-openssl-dev \
        libzmq3-dev \
        gcc \
        g++ \
        libffi-dev \
        libssl-dev \
        make \
        cmake \
        software-properties-common  
    
	rm -rf /var/lib/apt/lists/*

    export PYTHONNOUSERSITE="true"
    export PIP_BREAK_SYSTEM_PACKAGES=1

    add-apt-repository -y ppa:apptainer/ppa
    apt update
    apt install --no-install-recommends -y apptainer
    
    pip3 install jupyterlab

    # Clone the repository and set up directories
    git clone https://github.com/stela2502/Tutorial_Singularity.git
    mkdir /opt/ImageSmith
    cp -R Tutorial_Singularity/* /opt/ImageSmith
    # mountpoint for the open cosmos main storage area.

    mkdir /projects
    mkdir /local

    rm -rf /var/lib/apt/lists/*

    # Create a sudo script to bypass sudo requirement
    cat <<EOF > /usr/local/bin/sudo
#!/bin/bash

# Check if the script is running as root
echo "sudo not necessary in image..."
"\$@"
EOF
   chmod +x /usr/local/bin/sudo

%runscript
  jupyter lab --port 9734 --ip=0.0.0.0 --allow-root --no-browser
